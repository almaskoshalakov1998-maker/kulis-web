<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–ö“Ø–ª—ñ—Å ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä 2‚Äì9</title>
<style>
  :root{
    --bg:#0b7a2c; --board:#106b29; --panel:#135e27; --border:#0a4d1d;
    --text:#fff; --muted:#cfe8d5; --accent:#ffd84a; --chip:#113f21;
  }
  html,body{height:100%;}
  body{margin:0;background:#0e7c2f;color:var(--text);font-family:system-ui,Arial,sans-serif;}
  header{padding:14px 18px;background:#0b5f24;box-shadow:0 2px 0 rgba(0,0,0,.2);position:sticky;top:0;z-index:3}
  h1{margin:0;font-size:20px}
  main{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{
    width:68px;height:96px;border-radius:10px;background:#fff;color:#000;
    display:flex;align-items:center;justify-content:center;font-weight:700;
    box-shadow:0 2px 6px rgba(0,0,0,.35);border:2px solid #0006;cursor:pointer;user-select:none
  }
  .card.back{background:#1a3a27;color:#1a3a27;border-color:#0008;cursor:default}
  .card.disabled{pointer-events:none;opacity:.6}
  .wrap{background:var(--board);border:2px solid var(--border);border-radius:14px;padding:12px}
  .panel{background:var(--panel);border:1px solid #ffffff33;border-radius:12px;padding:12px}
  .label{font-weight:700;margin-bottom:6px}
  .btn{background:var(--accent);color:#000;border:none;border-radius:10px;padding:9px 14px;font-weight:800;cursor:pointer}
  .btn.secondary{background:#fff;color:#000}
  .btn.ghost{background:transparent;border:1px solid #fff;color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  #board{position:relative;margin:14px auto;max-width:980px;min-height:520px;background:var(--panel);
    border:2px solid #ffffff22;border-radius:18px;padding:10px}
  #tableCenter{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    min-width:260px;min-height:160px;border:2px dashed #ffffff55;border-radius:16px;
    display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:center;padding:12px;background:#0f6226aa
  }
  #topHand{position:absolute;top:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px}
  #bottomHand{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px}
  #hud{display:flex;gap:12px;flex-wrap:wrap}
  #log{background:#083d1a;border-radius:10px;padding:10px;height:180px;overflow:auto;font-size:14px}
  .chip{display:inline-block;background:var(--chip);border:1px solid #ffffff22;border-radius:999px;padding:2px 8px;margin-right:6px}
  .tag{display:inline-block;background:#134d27;border:1px solid #ffffff33;border-radius:8px;padding:2px 6px;margin-left:6px;font-size:12px}
  .hint{color:var(--muted);font-size:13px}
  .section-title{margin:6px 0 8px;font-weight:800}
  #playersList .seat{background:#0f5e26;border:1px solid #ffffff22;border-radius:10px;padding:8px 10px}
  #playersList .you{background:#195c2f}
</style>
</head>
<body>
<header>
  <h1>–ö“Ø–ª—ñ—Å ‚Äî –∫–∞—Ä—Ç–æ—á–Ω–∞—è –∏–≥—Ä–∞ (2‚Äì9 –∏–≥—Ä–æ–∫–æ–≤)</h1>
</header>
<main>

  <!-- –õ–û–ë–ë–ò -->
  <div id="lobby" class="wrap">
    <div class="row">
      <div class="panel" style="flex:2 1 360px;min-width:300px">
        <div class="section-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–æ–ª–∞</div>
        <div class="row">
          <div>
            <div class="label">–ö–æ–ª-–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (–≤–∫–ª—é—á–∞—è —Ç–µ–±—è):</div>
            <input id="numPlayers" type="number" min="2" max="9" value="2" style="width:90px;padding:6px;border-radius:8px;border:1px solid #fff"/>
          </div>
          <div>
            <div class="label">–°—Ç–∞–≤–∫–∏ (–º–∏–Ω‚Äì–º–∞–∫—Å), —Ç–≥:</div>
            <input id="minBet" type="number" value="100" style="width:100px;padding:6px;border-radius:8px;border:1px solid #fff"/> ‚Äî
            <input id="maxBet" type="number" value="500" style="width:100px;padding:6px;border-radius:8px;border:1px solid #fff"/>
          </div>
        </div>
        <div class="hint" style="margin-top:6px">–í—Å–µ –≤–Ω–æ—Å—è—Ç ¬´—à–∞—Ä¬ª (–º–∏–Ω–∏–º—É–º). –¢–æ—Ä–≥–∏ –∏–¥—É—Ç –ø–æ –∫—Ä—É–≥—É, –º–æ–∂–Ω–æ –ø–æ–≤—ã—à–∞—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∏–ª–∏ –ø–∞—Å–æ–≤–∞—Ç—å.</div>
      </div>
      <div class="panel" style="flex:1 1 240px;display:flex;align-items:end;justify-content:end">
        <button class="btn" id="startBtn">–°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–∞—á—É</button>
      </div>
    </div>
  </div>

  <!-- –ò–ì–†–û–í–û–ô –°–¢–û–õ -->
  <div id="game" class="wrap" style="display:none">
    <div id="hud" class="row">
      <div class="panel" style="flex:2 1 480px">
        <div class="label">–ö–æ–∑—ã—Ä—å: <span id="trumpView"></span>
          <span class="tag">–ª–µ–≤–∞—è: <span id="leftPalkaView"></span></span>
          <span class="tag">–ø—Ä–∞–≤–∞—è: <span id="rightPalkaView"></span></span>
        </div>
        <div id="status" class="hint">‚Äî</div>
      </div>
      <div class="panel" style="flex:1 1 280px">
        <div class="label">–ë–∞–Ω–∫: <span id="pot">0</span> —Ç–≥</div>
        <div id="betInfo" class="hint">‚Äî</div>
      </div>
      <div class="panel" style="flex:1 1 280px">
        <div class="label">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        <div id="playersList" class="row"></div>
      </div>
    </div>

    <div id="board">
      <div id="topHand"></div>
      <div id="tableCenter"></div>
      <div id="bottomHand"></div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="panel" style="flex:2 1 520px">
        <div class="label">–ñ—É—Ä–Ω–∞–ª</div>
        <div id="log"></div>
      </div>
      <div class="panel" style="flex:1 1 280px">
        <div class="label">–î–µ–π—Å—Ç–≤–∏—è</div>
        <div class="row">
          <button class="btn" id="btnAttack" disabled>–°—Ö–æ–¥–∏—Ç—å</button>
          <button class="btn secondary" id="btnDefend" disabled>–ë–∏—Ç—å</button>
          <button class="btn ghost" id="btnFold" disabled>–°–¥–∞—Ç—å—Å—è / –ü–∞—Å</button>
        </div>
        <div class="row" id="bettingControls" style="margin-top:8px;display:none">
          <input id="betInput" type="number" min="0" value="100" style="width:120px;padding:6px;border-radius:8px;border:1px solid #fff"/>
          <button class="btn" id="btnBet">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
          <button class="btn ghost" id="btnPass">–ü–∞—Å</button>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
/* ======================= –ú–û–î–ï–õ–¨ –ò –ü–†–ê–í–ò–õ–ê ======================= */
const SUITS = ["‚ô†","‚ô£","‚ô•","‚ô¶"];      // –ø–∞—Ä—ã: ‚ô†‚Üî‚ô£, ‚ô•‚Üî‚ô¶
const PAIR  = {"‚ô†":"‚ô£","‚ô£":"‚ô†","‚ô•":"‚ô¶","‚ô¶":"‚ô•"};
const RANKS = ["7","9","10","J","Q","K","A"];
const NON_TRUMP_ORDER = {"7":0,"9":1,"10":2,"J":3,"Q":4,"K":5,"A":6}; // –¥–ª—è –Ω–µ–∫–æ–∑—ã—Ä–µ–π
const CARD_POINTS = {"7":7,"9":9,"10":10,"J":10,"Q":10,"K":10,"A":11};
const fmt = c => c; // —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "J‚ô£"

function makeDeck(){ const d=[]; for(const s of SUITS) for(const r of RANKS) d.push(r+s); return d; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function leftPalka(tr){ return "7"+PAIR[tr]; }      // –ª–µ–≤–∞—è –ø–∞–ª–∫–∞ ‚Äî 7 –ø–∞—Ä—ã –∫–æ–∑—ã—Ä—è
function rightPalka(tr){ return "7"+tr; }           // –ø—Ä–∞–≤–∞—è –ø–∞–ª–∫–∞ ‚Äî 7 –∫–æ–∑—ã—Ä—è
function isLeft(c,tr){ return c===leftPalka(tr); }
function isRight(c,tr){ return c===rightPalka(tr); }
function isTrump(c,tr){ return c.slice(-1)===tr || isLeft(c,tr); }

/* –ü–æ—Ä—è–¥–æ–∫ –∫–æ–∑—ã—Ä–µ–π: A(—Å—Ç–∞—Ä—à–∏–π) > –ø—Ä–∞–≤–∞—è –ø–∞–ª–∫–∞ > –ª–µ–≤–∞—è –ø–∞–ª–∫–∞ > K > Q > J > 10 > 9 > 7-–∫–æ–∑—ã—Ä—å
   (—Å–æ–≥–ª–∞—Å–Ω–æ –æ–ø–∏—Å–∞–Ω–∏—é: –ø–∞–ª–∫–∏ —Å—Ç–∞—Ä—à–µ –≤—Å–µ—Ö –∫–æ–∑—ã—Ä–µ–π, –Ω–æ —Ç—É–∑ —Å—Ç–∞—Ä—à–µ –ø–∞–ª–æ–∫; –ø—Ä–∞–≤–∞—è > –ª–µ–≤–∞—è) */
function trumpPower(c,tr){
  if(!isTrump(c,tr)) return -1;
  const r=c.slice(0,-1), s=c.slice(-1);
  if(s===tr && r==="A") return 8;
  if(isRight(c,tr))     return 7;
  if(isLeft(c,tr))      return 6;
  const map={"K":5,"Q":4,"J":3,"10":2,"9":1,"7":0};
  return map[r] ?? 0;
}

function canBeat(attack, defend, tr){
  if(!attack || !defend) return false;
  const aT = isTrump(attack,tr), dT = isTrump(defend,tr);
  const aS = attack.slice(-1), dS = defend.slice(-1);
  if(!aT && dT) return true;                // –∫–æ–∑—ã—Ä—å –±—å—ë—Ç –Ω–µ–∫–æ–∑—ã—Ä—å
  if(aT && dT)  return trumpPower(defend,tr) > trumpPower(attack,tr);
  if(!aT && !dT && aS===dS) return NON_TRUMP_ORDER[defend.slice(0,-1)] > NON_TRUMP_ORDER[attack.slice(0,-1)];
  return false;
}

function cardPointsForKulis(c,tr){ if(isLeft(c,tr)||isRight(c,tr)) return 10.5; return CARD_POINTS[c.slice(0,-1)]; }

/* –ö–£–õ–ò–°:
   - —Ç—Ä–∏ —Ç—É–∑–∞ (A==—Ç—É–∑; –ª–µ–≤–∞—è/–ø—Ä–∞–≤–∞—è –ø–∞–ª–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è —Ç—É–∑–∞–º–∏ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏) ‚Äî —Å–∞–º—ã–π —Å—Ç–∞—Ä—à–∏–π
   - —Ç—Ä–∏ —Å–µ–º—ë—Ä–∫–∏ ‚Äî —Å—Ç–∞—Ä—à–µ –æ–±—ã—á–Ω—ã—Ö –∏ –∫–æ–∑—ã—Ä–Ω—ã—Ö
   - 3 –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏ (–∫–æ–∑—ã—Ä–Ω–æ–π/–Ω–µ –∫–æ–∑—ã—Ä–Ω–æ–π)
   - 2 –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏ + (–ª–µ–≤–∞—è|–ø—Ä–∞–≤–∞—è) –ø–∞–ª–∫–∞
   –ö–æ–∑—ã—Ä–Ω–æ–π –∫—É–ª–∏—Å —Å—Ç–∞—Ä—à–µ –Ω–µ-–∫–æ–∑—ã—Ä–Ω–æ–≥–æ, –¥–∞–∂–µ –ø—Ä–∏ –º–µ–Ω—å—à–∏—Ö –æ—á–∫–∞—Ö.
   –û—á–∫–∏: 7=7,9=9,10/J/Q/K=10, –ø–∞–ª–∫–∏=10.5, A=11.
   –ü—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ –æ—á–∫–æ–≤ –ø—Ä–∞–≤. –ø–∞–ª–∫–∞ > –ª–µ–≤. –ø–∞–ª–∫–∏.
*/
function detectKulis(hand,tr){
  const ranks = hand.map(c=>c.slice(0,-1));
  const suits = hand.map(c=>c.slice(-1));
  const hasL = hand.includes(leftPalka(tr));
  const hasR = hand.includes(rightPalka(tr));
  const asCount = ranks.filter(r=>r==="A").length;

  // —Ç—Ä–∏ "—Ç—É–∑–∞" —Å –∑–∞–º–µ–Ω–∞–º–∏ –ø–∞–ª–∫–∞–º–∏
  const asLike = asCount + (hasL?1:0) + (hasR?1:0);
  if(asLike>=3) return {exists:true, tier:4, trumpish:true, kind:"–¢—Ä–∏ —Ç—É–∑–∞", pts:33, hasR, hasL};

  // —Ç—Ä–∏ —Å–µ–º—ë—Ä–∫–∏
  if(ranks.every(r=>r==="7")){
    const pts=hand.reduce((s,c)=>s+cardPointsForKulis(c,tr),0);
    return {exists:true, tier:3, trumpish:false, kind:"–¢—Ä–∏ —Å–µ–º—ë—Ä–∫–∏", pts, hasR, hasL};
  }

  // 3 –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏
  const suitCount={}; suits.forEach(s=>suitCount[s]=(suitCount[s]||0)+1);
  const mono = Object.entries(suitCount).find(([s,c])=>c===3);
  if(mono){
    const s=mono[0]; const pts=hand.reduce((x,c)=>x+cardPointsForKulis(c,tr),0);
    const trumpish = (s===tr); // –∫–æ–∑—ã—Ä–Ω–æ–π –∫—É–ª–∏—Å
    return {exists:true, tier: trumpish?2:1, trumpish, kind:"–û–¥–Ω–∞ –º–∞—Å—Ç—å (3)", pts, hasR, hasL};
  }

  // 2 –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏ + –ø–∞–ª–∫–∞
  const pairSuit = Object.entries(suitCount).find(([s,c])=>c===2);
  if(pairSuit && (hasL||hasR)){
    const s=pairSuit[0]; const pts=hand.reduce((x,c)=>x+cardPointsForKulis(c,tr),0);
    const trumpish = (s===tr);
    return {exists:true, tier: trumpish?2:1, trumpish, kind:"2 –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏ + –ø–∞–ª–∫–∞", pts, hasR, hasL};
  }

  return {exists:false, tier:0, trumpish:false, kind:"‚Äî", pts:0, hasR, hasL};
}

// —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—É–ª–∏—Å–æ–≤: 1 –µ—Å–ª–∏ a>b, -1 –µ—Å–ª–∏ a<b, 0 –µ—Å–ª–∏ —Ä–∞–≤–Ω—ã
function compareKulis(a,b){
  if(a.tier!==b.tier) return a.tier>b.tier?1:-1;
  // –∫–æ–∑—ã—Ä–Ω–æ–π —Å—Ç–∞—Ä—à–µ –Ω–µ-–∫–æ–∑—ã—Ä–Ω–æ–≥–æ (–Ω–∞ –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ —É—Ä–æ–≤–Ω—è—Ö)
  if(a.trumpish!==b.trumpish) return a.trumpish?1:-1;
  if(a.pts!==b.pts) return a.pts>b.pts?1:-1;
  if(a.hasR!==b.hasR) return a.hasR?1:-1; // –ø—Ä–∞–≤–∞—è –ø–∞–ª–∫–∞ –ø–æ–±–µ–∂–¥–∞–µ—Ç –ª–µ–≤—É—é
  return 0;
}

/* ======================= –ò–ì–†–û–í–û–ô –°–ï–†–í–ï–† (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∏–º–∏—Ç–∞—Ü–∏—è) ======================= */
const $ = sel => document.querySelector(sel);
const logBox = $("#log");

function log(msg){ logBox.innerHTML += msg + "<br>"; logBox.scrollTop = logBox.scrollHeight; }
function setStatus(msg){ $("#status").textContent = msg; }
function setPot(v){ $("#pot").textContent = v; }
function setBetInfo(msg){ $("#betInfo").textContent = msg; }

let tableState = null;

function createTable(nPlayers,minBet,maxBet){
  // –∏–≥—Ä–æ–∫ 0 ‚Äî —á–µ–ª–æ–≤–µ–∫; –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –±–æ—Ç—ã
  const names = ["–¢—ã","–ë–æ—Ç –ê","–ë–æ—Ç –ë","–ë–æ—Ç –í","–ë–æ—Ç –ì","–ë–æ—Ç –î","–ë–æ—Ç –ï","–ë–æ—Ç –ñ","–ë–æ—Ç –ó"];
  const players = Array.from({length:nPlayers}, (_,i)=>({
    id:i, name:names[i], chips:100000, inHand:true, folded:false, bet:0, cards:[]
  }));

  // –∫–æ–ª–æ–¥–∞ –∏ –∫–æ–∑—ã—Ä—å
  const deck = makeDeck(); shuffle(deck);
  const trump = SUITS[Math.floor(Math.random()*SUITS.length)];
  const L = leftPalka(trump), R = rightPalka(trump);

  // —Å–¥–∞—á–∞ –ø–æ 3 –∏ ¬´–∫–æ–∑—ã—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –ª–µ–∂–∏—Ç –Ω–∞ –∑–µ–º–ª–µ –¥–æ –∫–æ–Ω—Ü–∞¬ª (–ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Å—Ç—å)
  for(const p of players){ p.cards = deck.splice(0,3); }

  // –ë–∞–Ω–∫: –≤—Å–µ –∫–∏–¥–∞—é—Ç ¬´—à–∞—Ä¬ª = minBet
  let pot = minBet * players.length; players.forEach(p=>p.bet=minBet);

  tableState = {
    stage:"betting", minBet, maxBet, pot,
    deck, trump, L, R,
    players, current:1, // —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Å–ª–µ —Å–¥–∞—é—â–µ–≥–æ (—Å–¥–∞—ë—Ç –∏–≥—Ä–æ–∫ 0 —É—Å–ª–æ–≤–Ω–æ)
    topPlayer:null, bottomPlayer:players[0], // –ø–æ–∑–∂–µ –¥–ª—è —Ñ–∏–Ω–∞–ª–∞
    attackCard:null, centerCards:[],
    lastRaise:minBet, highestBid:minBet, highestBidder:null,
    finalists:[], caller:null
  };
  renderHeader();
  renderPlayersList();
  renderHandsOnlyYou();
  renderTableCenter();
  updateBettingUI(true);
  logBox.innerHTML="";
  log(`–†–∞–∑–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞. –ö–æ–∑—ã—Ä—å: ${tableState.trump}. –í—Å–µ –≤–Ω–µ—Å–ª–∏ –ø–æ ${minBet} —Ç–≥.`);
  setStatus("–¢–æ—Ä–≥–∏: –¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏–ª–∏ –ø–∞—Å.");
  setBetInfo(`–î–∏–∞–ø–∞–∑–æ–Ω —Å—Ç–∞–≤–æ–∫: ${minBet}‚Äì${maxBet} —Ç–≥`);
}

function renderHeader(){
  $("#game").style.display="block";
  $("#lobby").style.display="none";
  $("#trumpView").textContent = tableState.trump;
  $("#leftPalkaView").textContent = tableState.L;
  $("#rightPalkaView").textContent = tableState.R;
  setPot(tableState.pot);
}

function renderPlayersList(){
  const box = $("#playersList"); box.innerHTML="";
  for(const p of tableState.players){
    const d = document.createElement("div");
    d.className="seat" + (p.id===0?" you":"");
    d.innerHTML = `<div><b>${p.name}</b></div>
      <div class="hint">—Å—Ç–∞–≤–∫–∞: ${p.bet} ‚Ä¢ ${p.folded?"–ø–∞—Å":"–≤ –∏–≥—Ä–µ"}</div>`;
    box.appendChild(d);
  }
}

function renderHandsOnlyYou(){
  const you = tableState.players[0];
  // bottom hand (you)
  const bottom = $("#bottomHand"); bottom.innerHTML="";
  you.cards.forEach(c=>{
    const el = document.createElement("div");
    el.className="card"; el.textContent=fmt(c);
    el.onclick = ()=>onYouClickCardDuringPlay(c);
    bottom.appendChild(el);
  });
  // top hand (opponent in final) ‚Äî –ø–æ–∫–∞ –ø—É—Å—Ç–æ/–∑–∞–∫—Ä—ã—Ç–æ
  $("#topHand").innerHTML="";
}

function renderFinalHands(){
  // –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–∞—Ä—É (–∏–≥—Ä–æ–∫ 0 –∏ —Å–æ–ø–µ—Ä–Ω–∏–∫)
  const you = tableState.bottomPlayer;
  const opp = tableState.topPlayer;

  const bottom = $("#bottomHand"); bottom.innerHTML="";
  you.cards.forEach(c=>{
    const el = document.createElement("div"); el.className="card"; el.textContent=fmt(c);
    el.onclick = ()=>onYouClickCardDuringPlay(c);
    bottom.appendChild(el);
  });

  const top = $("#topHand"); top.innerHTML="";
  opp.cards.forEach(()=>{ const el = document.createElement("div"); el.className="card back"; el.textContent="üÇ†"; top.appendChild(el); });

  $("#btnFold").disabled=false;
}

function renderTableCenter(){
  const area = $("#tableCenter"); area.innerHTML="";
  for(const c of tableState.centerCards){
    const el = document.createElement("div"); el.className="card"; el.textContent=fmt(c);
    area.appendChild(el);
  }
}

function updateBettingUI(show){
  $("#bettingControls").style.display = show?"flex":"none";
  $("#btnFold").textContent = show ? "–ü–∞—Å" : "–°–¥–∞—Ç—å—Å—è";
  $("#btnAttack").disabled = true;
  $("#btnDefend").disabled = true;
  $("#btnFold").disabled = !show;
  if(show){
    $("#betInput").min = tableState.minBet;
    $("#betInput").max = tableState.maxBet;
    $("#betInput").value = Math.max(tableState.lastRaise, tableState.minBet);
  }
}

/* ======================= –¢–û–†–ì–ò ======================= */
function nextActivePlayer(from){
  const n = tableState.players.length;
  for(let i=1;i<=n;i++){
    const idx = (from + i) % n;
    const p = tableState.players[idx];
    if(!p.folded) return idx;
  }
  return from;
}

function countActive(){ return tableState.players.filter(p=>!p.folded).length; }

function humanBet(value){
  const me = tableState.players[0];
  if(value < tableState.minBet || value > tableState.maxBet){ log("–°—Ç–∞–≤–∫–∞ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞."); return; }
  if(value < tableState.lastRaise){ log(`–ù—É–∂–Ω–æ –Ω–µ –º–µ–Ω—å—à–µ ${tableState.lastRaise}.`); return; }
  me.bet = value;
  if(value>tableState.highestBid){ tableState.highestBid=value; tableState.highestBidder=me.id; }
  log(`–¢—ã –ø–æ—Å—Ç–∞–≤–∏–ª ${value}.`);
  setPot(tableState.pot); renderPlayersList();
  advanceBetting();
}

function humanPass(){
  const me = tableState.players[0];
  me.folded = true;
  log("–¢—ã –ø–∞—Å–æ–≤–∞–ª.");
  renderPlayersList();
  advanceBetting();
}

function botBetLogic(p){
  const k = detectKulis(p.cards, tableState.trump);
  // –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–∏–ª—ã —Ä—É–∫–∏ –¥–ª—è –±–æ—Ç–∞
  let strength = k.exists ? (k.tier*10 + (k.trumpish?3:0) + Math.min(5, Math.floor(k.pts))) :
    p.cards.reduce((s,c)=>s + (isTrump(c,tableState.trump)?2:0) + NON_TRUMP_ORDER[c.slice(0,-1)]/10, 0);
  // —Ä–µ—à–∞–µ–º: –ø–∞—Å–æ–≤–∞—Ç—å, —É—Ä–∞–≤–Ω—è—Ç—å, –ø—Ä–∏–ø–æ–¥–Ω—è—Ç—å
  const desire = strength >= 16 ? "raise" : strength >= 10 ? "call" : "fold";
  let bid = tableState.lastRaise;
  if(desire==="fold"){ p.folded=true; log(`${p.name} –ø–∞—Å–æ–≤–∞–ª.`); return; }
  if(desire==="raise"){
    bid = Math.min(tableState.maxBet, Math.max(tableState.lastRaise, tableState.minBet) + 50);
  }
  p.bet = bid;
  if(bid>tableState.highestBid){ tableState.highestBid=bid; tableState.highestBidder=p.id; }
  log(`${p.name} –ø–æ—Å—Ç–∞–≤–∏–ª ${bid}.`);
}

function startBettingTurn(){
  setStatus("–¢–æ—Ä–≥–∏: –¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏–ª–∏ –ø–∞—Å.");
  updateBettingUI(true);
  setBetInfo(`–¢–µ–∫—É—â–∏–π –º–∏–Ω–∏–º—É–º: ${tableState.lastRaise}, –º–∞–∫—Å–∏–º—É–º: ${tableState.maxBet}. –ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: ${countActive()}.`);
  if(tableState.current!==0){
    // —Ö–æ–¥ –±–æ—Ç–∞
    const p = tableState.players[tableState.current];
    if(!p.folded) botBetLogic(p);
    renderPlayersList();
    // –æ–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–µ–±—É–µ–º—ã–π –º–∏–Ω–∏–º—É–º (—É—Ä–∞–≤–Ω—è—Ç—å –º–∞–∫—Å–∏–º—É–º)
    tableState.lastRaise = Math.max(tableState.lastRaise, tableState.highestBid);
    tableState.current = nextActivePlayer(tableState.current);
    setTimeout(checkBettingEnd, 350);
  }
}

function advanceBetting(){
  // —á–µ–ª–æ–≤–µ–∫ –ø–æ—Ö–æ–¥–∏–ª; –æ–±–Ω–æ–≤–∏–º –º–∏–Ω–∏–º–∞–ª–∫—É
  tableState.lastRaise = Math.max(tableState.lastRaise, tableState.highestBid);
  tableState.current = nextActivePlayer(tableState.current);
  checkBettingEnd();
}

function checkBettingEnd(){
  const active = tableState.players.filter(p=>!p.folded);
  if(active.length===1){
    // –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ—É—Ä–∞–≤–Ω—ë–Ω–Ω—ã–π ‚Äî –∑–∞–±–∏—Ä–∞–µ—Ç –±–∞–Ω–∫
    const winner = active[0]; log(`–ù–∏–∫—Ç–æ –Ω–µ —Å—Ä–∞–≤–Ω—è–ª. ${winner.name} –∑–∞–±–∏—Ä–∞–µ—Ç –±–∞–Ω–∫ ${tableState.pot} —Ç–≥.`);
    endHand(winner.id);
    return;
  }
  // –ø—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –¥–≤–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É—Ä–∞–≤–Ω—è–ª–∏—Å—å (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Å–∞–Ω—É–ª–∏)
  // —É—Å–ª–æ–≤–∏–µ: –∞–∫—Ç–∏–≤–Ω—ã—Ö 2 ‚Üí —Å—Ç–∞–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–≤–Ω—ã; –∫—Ç–æ —É—Ä–∞–≤–Ω—è–ª ‚Äî —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º
  if(active.length===2){
    const [a,b] = active;
    if(a.bet===b.bet){
      tableState.finalists = [a.id,b.id];
      tableState.caller = (a.id===tableState.highestBidder ? b.id : a.id); // —É—Ä–∞–≤–Ω—è–≤—à–∏–π
      log(`–í —Ñ–∏–Ω–∞–ª–µ: ${tableState.players[a.id].name} vs ${tableState.players[b.id].name}. –•–æ–¥–∏—Ç —É—Ä–∞–≤–Ω—è–≤—à–∏–π: ${tableState.players[tableState.caller].name}.`);
      startFinal();
      return;
    }
  }
  // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–æ—Ä–≥–∏
  startBettingTurn();
}

/* ======================= –ü–ï–†–ï–•–û–î –ö –§–ò–ù–ê–õ–£ ======================= */
function startFinal(){
  tableState.stage="final";
  updateBettingUI(false);
  // –Ω–∞–∑–Ω–∞—á–∏–º –Ω–∏–∂–Ω–µ–≥–æ = —á–µ–ª–æ–≤–µ–∫, –≤–µ—Ä—Ö–Ω–µ–≥–æ = —Å–æ–ø–µ—Ä–Ω–∏–∫ (–µ—Å–ª–∏ —Ñ–∏–Ω–∞–ª–µ –Ω–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –±–æ—Ç–æ–≤—É—é –¥—É—ç–ª—å)
  const [p1,p2] = tableState.finalists;
  const caller = tableState.caller;

  // —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º: –≤ –≤–∏–∑—É–∞–ª–µ —Å–Ω–∏–∑—É ‚Äî —á–µ–ª–æ–≤–µ–∫, —Å–≤–µ—Ä—Ö—É ‚Äî —Å–æ–ø–µ—Ä–Ω–∏–∫ (–µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–µ—Ç ‚Äî —Å–Ω–∏–∑—É –ø–µ—Ä–≤—ã–π —Ñ–∏–Ω–∞–ª–∏—Å—Ç)
  if(p1===0 || p2===0){
    tableState.bottomPlayer = tableState.players[0];
    tableState.topPlayer = tableState.players[p1===0?p2:p1];
  }else{
    tableState.bottomPlayer = tableState.players[p1];
    tableState.topPlayer = tableState.players[p2];
  }

  // –ö–£–õ–ò–°–´ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–µ–¥ –±–æ–µ–º: —Å–Ω–∞—á–∞–ª–∞ —Å–¥–∞—é—â–∏–π/—Ä–∞–∑–¥–∞–≤—à–∏–π? –ü–æ —Ç–≤–æ–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é: —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —Ö–æ–¥–∏—Ç.
  const attacker = (caller===tableState.bottomPlayer.id) ? tableState.bottomPlayer : tableState.topPlayer;
  const defender = (attacker===tableState.bottomPlayer)? tableState.topPlayer : tableState.bottomPlayer;

  const kA = detectKulis(attacker.cards, tableState.trump);
  const kD = detectKulis(defender.cards, tableState.trump);

  if(kA.exists){
    log(`‚û°Ô∏è ${attacker.name} —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –∫—É–ª–∏—Å: ${kA.kind} (–æ—á–∫–æ–≤: ${sumKulis(attacker.cards)})`);
    if(kD.exists){
      log(`‚û°Ô∏è ${defender.name} —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –∫—É–ª–∏—Å: ${kD.kind} (–æ—á–∫–æ–≤: ${sumKulis(defender.cards)})`);
      const cmp = compareKulis(kA,kD);
      if(cmp>0) return endHand(attacker.id, "–ü–æ–±–µ–¥–∞ –ø–æ –∫—É–ª–∏—Å—É");
      if(cmp<0) return endHand(defender.id, "–ü–æ–±–µ–¥–∞ –ø–æ –∫—É–ª–∏—Å—É");
      return splitPot("–†–∞–≤–µ–Ω—Å—Ç–≤–æ –∫—É–ª–∏—Å–æ–≤ ‚Äî –±–∞–Ω–∫ –¥–µ–ª–∏—Ç—Å—è.");
    }else{
      return endHand(attacker.id, "–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–æ–±–µ–¥–∞ –ø–æ –∫—É–ª–∏—Å—É");
    }
  }else if(kD.exists){
    log(`‚û°Ô∏è ${defender.name} —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –∫—É–ª–∏—Å: ${kD.kind} (–æ—á–∫–æ–≤: ${sumKulis(defender.cards)})`);
    return endHand(defender.id, "–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–æ–±–µ–¥–∞ –ø–æ –∫—É–ª–∏—Å—É");
  }

  // –µ—Å–ª–∏ –∫—É–ª–∏—Å–æ–≤ –Ω–µ—Ç ‚Äî –∏–≥—Ä–∞–µ–º –¥—É—ç–ª—å 3-–∫–∞—Ä—Ç (–ø–æ–¥–∫–∏–¥–Ω–æ–π‚Äë–æ–±—Ä–∞–∑–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
  tableState.centerCards=[]; renderTableCenter();
  renderFinalHands();

  // –ö—Ç–æ —Ö–æ–¥–∏—Ç: —É—Ä–∞–≤–Ω—è–≤—à–∏–π
  tableState.attackerId = caller;
  tableState.defenderId = (caller===tableState.bottomPlayer.id)? tableState.topPlayer.id : tableState.bottomPlayer.id;
  tableState.step = 0; // 0: –∞—Ç–∞–∫–∞1; 1: –∑–∞—â–∏—Ç–∞+–∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞ –±–æ—Ç–∞; 2: –∑–∞—â–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞; 3: –ø–æ—Å–ª–µ–¥–Ω—è—è –∞—Ç–∞–∫–∞ –∞—Ç–∞–∫—É—é—â–µ–≥–æ; 4: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
  setStatus(`${tableState.players[tableState.attackerId].name} —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º. –í—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç—É –¥–ª—è –∞—Ç–∞–∫–∏.`);
  enableAttackIfHumanTurn();
}

function sumKulis(hand){ return hand.reduce((s,c)=>s+cardPointsForKulis(c, tableState.trump),0); }

/* ======================= –î–£–≠–õ–¨ 3 –ö–ê–†–¢ ======================= */
function humanIsBottom(){ return tableState.bottomPlayer.id===0; }
function humanTurnToAttack(){ return tableState.attackerId===0; }
function humanTurnToDefend(){ return tableState.defenderId===0; }

function enableAttackIfHumanTurn(){
  $("#btnFold").disabled=false;
  $("#btnAttack").disabled = !humanTurnToAttack();
  $("#btnDefend").disabled = true;
}

function enableDefenseIfHumanTurn(){
  $("#btnFold").disabled=false;
  $("#btnAttack").disabled = true;
  $("#btnDefend").disabled = !humanTurnToDefend();
}

function onYouClickCardDuringPlay(card){
  if(tableState.stage!=="final") return;
  const me = tableState.players[0];
  if(humanTurnToAttack()){
    // –ê–¢–ê–ö–ê
    playAttack(me, card);
  }else if(humanTurnToDefend()){
    // –ó–ê–©–ò–¢–ê
    const atk = tableState.centerCards[tableState.centerCards.length-1];
    if(!canBeat(atk, card, tableState.trump)){ log("–≠—Ç–æ–π –∫–∞—Ä—Ç–æ–π –Ω–µ–ª—å–∑—è –ø–æ–±–∏—Ç—å."); return; }
    removeCard(me.cards, card);
    tableState.centerCards.push(card); renderTableCenter(); renderFinalHands();
    log(`–¢—ã –±—å—ë—à—å ${atk} –∫–∞—Ä—Ç–æ–π ${card}.`);
    // –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –ª–æ–≥–∏–∫–µ
    afterDefenseByHuman();
  }
}

// —É—Ç–∏–ª–∏—Ç—ã
function removeCard(arr, c){ const i=arr.indexOf(c); if(i>=0) arr.splice(i,1); }
function chooseMinDefense(hand, atk, tr){
  const opts = hand.filter(c=>canBeat(atk,c,tr));
  if(opts.length===0) return null;
  // –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è
  return opts.sort((a,b)=>{
    const aT=isTrump(a,tr), bT=isTrump(b,tr), atkT=isTrump(atk,tr);
    if(atkT) return trumpPower(a,tr)-trumpPower(b,tr);
    const aSame = !isTrump(a,tr) && a.slice(-1)===atk.slice(-1);
    const bSame = !isTrump(b,tr) && b.slice(-1)===atk.slice(-1);
    if(aSame!==bSame) return aSame?-1:1;
    if(aT&&bT) return trumpPower(a,tr)-trumpPower(b,tr);
    if(!aT&&!bT) return NON_TRUMP_ORDER[a.slice(0,-1)]-NON_TRUMP_ORDER[b.slice(0,-1)];
    return 0;
  })[0];
}
function chooseBotAttack(hand,tr){
  if(hand.length===0) return null;
  const score = c=>{
    const t=isTrump(c,tr); const r=c.slice(0,-1);
    let base = t? 100+trumpPower(c,tr) : NON_TRUMP_ORDER[r];
    if(r==="A") base+=10; if(isLeft(c,tr)||isRight(c,tr)) base+=8;
    return base;
  };
  return hand.slice().sort((a,b)=>score(a)-score(b))[0];
}

function playAttack(playerObj, card){
  removeCard(playerObj.cards, card);
  tableState.centerCards.push(card);
  renderTableCenter(); renderFinalHands();
  log(`${playerObj.name} —Ö–æ–¥–∏—Ç ${card}.`);
  // –∑–∞—â–∏—Ç–Ω–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç
  const defender = tableState.players[tableState.defenderId];
  setTimeout(()=>botOrHumanDefend(defender, card), 300);
}

function botOrHumanDefend(defender, atkCard){
  if(defender.id===0){
    // —á–µ–ª–æ–≤–µ–∫ ‚Äî –≤–∫–ª—é—á–∞–µ–º –∑–∞—â–∏—Ç—É
    setStatus("–ù—É–∂–Ω–æ –ø–æ–±–∏—Ç—å –∫–∞—Ä—Ç—É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.");
    enableDefenseIfHumanTurn();
    return;
  }
  const d = chooseMinDefense(defender.cards, atkCard, tableState.trump);
  if(!d){
    // –Ω–µ —Å–º–æ–≥ –ø–æ–±–∏—Ç—å ‚Äî –∞—Ç–∞–∫—É—é—â–∏–π –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç
    return endHand(tableState.attackerId, "–ó–∞—â–∏—Ç–Ω–∏–∫ –Ω–µ —Å–º–æ–≥ –ø–æ–±–∏—Ç—å");
  }
  removeCard(defender.cards, d); tableState.centerCards.push(d);
  renderTableCenter(); renderFinalHands();
  log(`${defender.name} –±—å—ë—Ç ${atkCard} –∫–∞—Ä—Ç–æ–π ${d}.`);

  // –ø–æ—Å–ª–µ —É–¥–∞—á–Ω–æ–π –∑–∞—â–∏—Ç—ã –∑–∞—â–∏—Ç–Ω–∏–∫ –°–†–ê–ó–£ –ø–æ–¥–∫–∏–¥—ã–≤–∞–µ—Ç —Å–≤–æ—é –∫–∞—Ä—Ç—É (–≤—Å—Ç—Ä–µ—á–Ω—ã–π —Ö–æ–¥)
  const attack2 = chooseBotAttack(defender.cards, tableState.trump);
  if(!attack2){
    // —É –∑–∞—â–∏—Ç–Ω–∏–∫–∞ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∫–∞—Ä—Ç ‚Äî –∞—Ç–∞–∫—É—é—â–∏–π –ø–æ–±–µ–∂–¥–∞–µ—Ç
    return endHand(tableState.attackerId, "–ó–∞—â–∏—Ç–Ω–∏–∫ –æ—Ç–±–∏–ª—Å—è, –Ω–æ –±–µ–∑ –∫–∞—Ä—Ç");
  }
  removeCard(defender.cards, attack2); tableState.centerCards.push(attack2);
  renderTableCenter(); renderFinalHands();
  log(`${defender.name} –ø–æ–¥–∫–∏–¥—ã–≤–∞–µ—Ç ${attack2}.`);
  // —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–∂–Ω–∏–π –∞—Ç–∞–∫—É—é—â–∏–π –¥–æ–ª–∂–µ–Ω –ø–æ–±–∏—Ç—å
  const newDefId = tableState.attackerId;
  tableState.attackerId = defender.id; // —Ä–æ–ª–∏ —Å–º–µ–Ω–∏–ª–∏—Å—å –¥–ª—è —ç—Ç–∞–ø–∞
  tableState.defenderId = newDefId;

  const newDef = tableState.players[newDefId];
  if(newDef.id===0){
    setStatus("–ù—É–∂–Ω–æ –ø–æ–±–∏—Ç—å –ø–æ–¥–∫–∏–Ω—É—Ç—É—é –∫–∞—Ä—Ç—É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.");
    enableDefenseIfHumanTurn();
  }else{
    // –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–±–∏—Ç—å
    const beat = chooseMinDefense(newDef.cards, attack2, tableState.trump);
    if(!beat) return endHand(defender.id, "–ê—Ç–∞–∫—É—é—â–∏–π –Ω–µ —Å–º–æ–≥ –ø–æ–±–∏—Ç—å –≤—Å—Ç—Ä–µ—á–Ω—É—é –∫–∞—Ä—Ç—É");
    removeCard(newDef.cards, beat); tableState.centerCards.push(beat);
    renderTableCenter(); renderFinalHands();
    log(`${newDef.name} –±—å—ë—Ç –≤—Å—Ç—Ä–µ—á–Ω—É—é ${attack2} –∫–∞—Ä—Ç–æ–π ${beat}.`);

    // –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞—á–∞–ª—å–Ω—ã–π –∞—Ç–∞–∫—É—é—â–∏–π (—Ç–µ–ø–µ—Ä—å —Å–Ω–æ–≤–∞ –∞—Ç–∞–∫—É–µ—Ç) –∫–ª–∞–¥—ë—Ç —Å–≤–æ—é –ø–æ—Å–ª–µ–¥–Ω—é—é
    const attackerNow = newDef; // –æ–Ω –æ—Ç–±–∏–ª, —Ç–µ–ø–µ—Ä—å –æ–Ω –∞—Ç–∞–∫—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π
    const last = chooseBotAttack(attackerNow.cards, tableState.trump);
    if(!last) return endHand(defender.id, "–ê—Ç–∞–∫—É—é—â–∏–π –æ—Ç–±–∏–ª –∏ –≤—ã—à–µ–ª –∏–∑ –∫–∞—Ä—Ç");
    removeCard(attackerNow.cards, last); tableState.centerCards.push(last);
    renderTableCenter(); renderFinalHands();
    log(`${attackerNow.name} –∫–ª–∞–¥—ë—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é ${last}.`);

    // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ —É —Ç–µ–∫—É—â–µ–≥–æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞ (defender, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–∫–∏–¥—ã–≤–∞–ª)
    const finalDefender = defender;
    const finalBeat = chooseMinDefense(finalDefender.cards, last, tableState.trump);
    if(!finalBeat) return endHand(attackerNow.id, "–§–∏–Ω–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –Ω–µ –æ—Ç–±–∏—Ç–∞");
    removeCard(finalDefender.cards, finalBeat); tableState.centerCards.push(finalBeat);
    renderTableCenter(); renderFinalHands();
    log(`${finalDefender.name} –±—å—ë—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é ${last} –∫–∞—Ä—Ç–æ–π ${finalBeat}.`);
    // –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–±–∏–ª—Å—è ‚Üí –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç –∑–∞—â–∏—Ç–Ω–∏–∫
    return endHand(finalDefender.id, "–ó–∞—â–∏—Ç–Ω–∏–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–±–∏–ª—Å—è");
  }
}

function afterDefenseByHuman(){
  // –∏–≥—Ä–æ–∫ –æ—Ç–±–∏–ª –≤—Å—Ç—Ä–µ—á–Ω—É—é ‚Äî —Ç–µ–ø–µ—Ä—å –æ–Ω –¥–æ–ª–∂–µ–Ω –ø–æ–ª–æ–∂–∏—Ç—å —Å–≤–æ—é –ø–æ—Å–ª–µ–¥–Ω—é—é
  const me = tableState.players[0];
  setStatus("–ü–æ–ª–æ–∂–∏ —Å–≤–æ—é –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–∞—Ä—Ç—É.");
  $("#btnAttack").disabled=false; // —Ä–∞–∑—Ä–µ—à–∏–º –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –∫–∞–∫ ¬´–∞—Ç–∞–∫–∞¬ª
}

function onSurrender(){
  if(tableState.stage==="betting"){
    humanPass();
  }else if(tableState.stage==="final"){
    const youLoseTo = tableState.players[tableState.defenderId]; // –ø—Ä–∏—Å—É–∂–¥–∞–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫—É
    endHand(youLoseTo.id, "–ò–≥—Ä–æ–∫ —Å–¥–∞–ª—Å—è");
  }
}

function endHand(winnerId, reason=""){
  const winner = tableState.players[winnerId];
  log(`<b>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name}</b> ${reason?`‚Äî ${reason}.`:""}`);
  setStatus(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name}.`);
  setPot(tableState.pot);
  $("#btnAttack").disabled=true; $("#btnDefend").disabled=true; $("#btnFold").disabled=true;
}

function splitPot(msg){
  log(`<b>${msg}</b>`);
  setStatus(msg);
  $("#btnAttack").disabled=true; $("#btnDefend").disabled=true; $("#btnFold").disabled=true;
}

/* ======================= UI –ö–ù–û–ü–ö–ò ======================= */
$("#startBtn").onclick = ()=>{
  const n = Math.max(2, Math.min(9, parseInt($("#numPlayers").value||"2")));
  const minB = parseInt($("#minBet").value||"100");
  const maxB = parseInt($("#maxBet").value||"500");
  createTable(n, minB, maxB);
  // –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ö–æ–¥ —Ç–æ—Ä–≥–æ–≤ —Å –ø–æ–∑–∏—Ü–∏–∏ current
  startBettingTurn();
};
$("#btnBet").onclick = ()=> humanBet(parseInt($("#betInput").value||"0"));
$("#btnPass").onclick = ()=> humanPass();
$("#btnFold").onclick = ()=> onSurrender();

// —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫; –∞—Ç–∞–∫–∞/–∑–∞—â–∏—Ç–∞ –¥–µ–ª–∞—é—Ç—Å—è –∫–ª–∏–∫–æ–º –ø–æ –∫–∞—Ä—Ç–µ —Å–Ω–∏–∑—É)
$("#btnAttack").onclick = ()=> setStatus("–í—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç—É —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å—Ö–æ–¥–∏—Ç—å.");
$("#btnDefend").onclick = ()=> setStatus("–í—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç—É —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –±–∏—Ç—å.");

/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ */
setTimeout(()=>{ $("#lobby").scrollIntoView({behavior:"smooth"}); }, 200);
</script>
</body>
</html>
